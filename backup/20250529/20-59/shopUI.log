const { EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
const shopItems = require('./shopItems');
const { formatUserHeader } = require('./embedParts');

function buildShopEmbed(data, user) {
  const embed = new EmbedBuilder()
    .setTitle('üõçÔ∏è Veres-Shop')
    .setDescription('Kaufe Upgrades mit Leveln ‚Äì je √∂fter du kaufst, desto teurer wird es.')
    .setColor(0xff66cc)
    .setAuthor({
      name: user.username,
      iconURL: user.displayAvatarURL({ dynamic: true })
    })
    .setThumbnail(user.displayAvatarURL({ size: 256, dynamic: true }))
    .addFields(...formatUserHeader(user, data.coins, data.title || '‚Äì', data.streak ?? 0));

  for (const [name, item] of Object.entries(shopItems)) {
    const level = data.upgradeLevels?.[name] ?? 0;
    const max = item.maxLevel;
    const price = level < max
      ? Math.floor(item.basePrice * Math.pow(item.scaling, level))
      : 'üîí MAX';

    embed.addFields({
      name: `${name} (Lv. ${level}/${max})`,
      value: `${item.description}\nüí∞ Preis: ${price}${item.role ? `\nüéñÔ∏è Rolle: ${item.role}` : ''}`,
      inline: false
    });
  }

  embed.setFooter({ text: `.${user.username}` });
  return embed;
}

function buildInventoryEmbed(data, user) {
  const upgrades = data.upgradeLevels ?? {};
  const coins = data.coins ?? 0;
  const streak = data.streak ?? 0;
  const title = data.title || '‚Äì';

  const hearts = Object.values(data.inventory ?? {}).reduce((a, b) => a + b, 0);
  const rares = (data.inventory?.Rare ?? 0) + (data.inventory?.Epic ?? 0) + (data.inventory?.Legendary ?? 0);

  const equipped = Object.entries(shopItems).map(([name, item]) => {
    const lvl = upgrades[name] ?? 0;
    return `‚Ä¢ **${name}**: Lv.${lvl}/${item.maxLevel}`;
  }).join('\n');

  const stats = [
    `‚Ä¢ ‚ù§Ô∏è Herzen gesamt: ${hearts}`,
    `‚Ä¢ üíé Seltene Herzen: ${rares}`,
    `‚Ä¢ üî• Streak: ${streak}`,
    `‚Ä¢ üè∑Ô∏è Titel: ${title}`
  ].join('\n');

  return new EmbedBuilder()
    .setTitle('üéí Dein Inventar')
    .setColor(0xff66cc)
    .setAuthor({
      name: user.username,
      iconURL: user.displayAvatarURL({ dynamic: true })
    })
    .setThumbnail(user.displayAvatarURL({ size: 256, dynamic: true }))
    .setDescription(
      `**üí∞ Coins:** ${coins}\n**üè∑Ô∏è Titel:** ${title}\n**üî• Streak:** ${streak}\n\n` +
      `__üß∞ Ausr√ºstung__\n${equipped}\n\n__üìä Stats__\n${stats}`
    )
    .setFooter({ text: `.${user.username}` });
}

function buildShopButtons(data) {
  const rows = [];
  let row = new ActionRowBuilder();

  for (const [name, item] of Object.entries(shopItems)) {
    const level = data.upgradeLevels?.[name] ?? 0;
    if (level >= item.maxLevel) continue;

    const button = new ButtonBuilder()
      .setCustomId(`buy_${name}`)
      .setLabel(`Kaufen: ${name}`)
      .setStyle(ButtonStyle.Primary);

    row.addComponents(button);
    if (row.components.length === 5) {
      rows.push(row);
      row = new ActionRowBuilder();
    }
  }

  if (row.components.length > 0) rows.push(row);
  return rows;
}

module.exports = {
  buildShopEmbed,
  buildInventoryEmbed,
  buildShopButtons
};